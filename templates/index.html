<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PirisBoard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="light">
    <div class="fixed-bar">
        <div class="theme-toggle">
            <button onclick="switchTheme()">テーマを切り替える</button>
        </div>
        <div class="form-container">
            <input type="text" id="user_name" name="user_name" placeholder="名前" required>
            <textarea id="message" name="message" rows="1" placeholder="メッセージ" required></textarea>
            <button type="button" onclick="submitForm(event)">投稿する</button>
        </div>
    </div>

    <div class="container">
        <h1>PirisBoard</h1>
        <div class="message-list">
            <ul id="messageList">
                <!-- メッセージはここに追加されます -->
            </ul>
        </div>
    </div>

    <button class="scroll-to-bottom" onclick="scrollToBottom()">一番下に行く</button>
    <button class="load-messages" onclick="loadMessages()">メッセージを読み込む</button>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadMessages();
            startPollingMessages();
        });

        // 新しいメッセージのポーリング
        function startPollingMessages() {
            setInterval(async function () {
                await loadMessages(false);  // メッセージ読み込みの際にスクロールしない
            }, 5000); // 5秒ごとにチェック
        }

        async function loadMessages(scrollToBottomAfterLoad = true) {
            const response = await fetch('/api/messages');
            const data = await response.json();
            const messageList = document.getElementById('messageList');

            messageList.innerHTML = ''; // リストをクリア

            data.messages.forEach(({ user_name, message }, index) => {
                addMessageToList(user_name, message, index + 1);
            });

            // 新しいメッセージがあれば一番下にスクロール
            if (scrollToBottomAfterLoad) {
                scrollToBottom();
            }
        }

        async function submitForm(event) {
            event.preventDefault();
            const user_name = document.getElementById('user_name').value;
            const message = document.getElementById('message').value;

            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_name, message }),
            });

            if (response.ok) {
                loadMessages();  // 送信後にメッセージを再読み込み
                document.getElementById('user_name').value = '';
                document.getElementById('message').value = '';
                scrollToBottom();
            }
        }

        function addMessageToList(user_name, message, index) {
            const messageList = document.getElementById('messageList');
            const newMessage = document.createElement('li');
            newMessage.innerHTML = `<strong>${user_name}</strong>: ${message}`;
            messageList.appendChild(newMessage);

            // アニメーションの追加
            setTimeout(() => {
                newMessage.style.animation = 'fadeIn 0.5s forwards';
            }, 100);
        }

        // テーマの切り替え
        function switchTheme() {
            const body = document.body;
            body.classList.toggle('light');
            body.classList.toggle('dark');
        }

        // 一番下にスクロールする
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
    </script>
</body>
</html>
